<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Annoter</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preload" href="{{ url_for('static', filename='style.css') }}" as="style">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<header>
  <h1>Annoter l'image</h1>
  <nav>
    <a href="{{ url_for('dashboard') }}">Voir le tableau de bord</a>
  </nav>
</header>

<main>
  <img src="{{ url_for('static', filename='uploads/' + filename) }}" width="300" loading="lazy" alt="Image à annoter"><br><br>

  {% if image[3] %}
  <div class="notification {{ image[3] }}">
    <strong>Classification automatique :
      <span style="background-color: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-weight: bold;">
        {{ image[3].upper() }}
      </span>
    </strong>
    <br>
    <small style="opacity: 0.9;">Vous pouvez modifier cette classification ci-dessous si nécessaire.</small>
  </div>
  {% endif %}

  <form method="post">
    {% set fields = {
      'avg_color': image[7],
      'edge_count': image[9],
      'contrast': image[8],
      'width': image[4],
      'height': image[5],
      'hist_luminance': image[11],
      'bin_edge_count': image[12] or 0,
      'bin_area': image[13] or 1
    } %}
    {% for key, val in fields.items() %}
      <input type="hidden" name="{{ key }}" value="{{ val }}">
    {% endfor %}

    <button type="submit" name="annotation" value="pleine">Pleine</button>
    <button type="submit" name="annotation" value="vide">Vide</button>
    <button type="submit" name="annotation" value="Adeterminer">À déterminer par l'IA</button>
  </form>

  <h2>Métadonnées</h2>
  <ul>
    <li>Taille fichier : {{ image[6] }} octets</li>
    <li>Dimensions : {{ image[4] }} x {{ image[5] }} px</li>
    <li>Couleur moyenne : {{ image[7] }}
      <span class="avg-color-box" id="avg-color-box"></span>
    </li>
    <li>Contraste : {{ image[8] }}</li>
    <li>Contours détectés : {{ image[9] }}</li>
    {% if image[12] and image[13] %}
    <li>Contours dans la benne : {{ image[12] }} ({{ image[13] }} px)</li>
    <li>Densité benne : {{ "%.4f"|format(image[12] / image[13]) }}</li>
    {% endif %}
  </ul>

  {% if image[3] %}
  <section aria-label="Analyse améliorée">
    <!-- Rendu allégé + accessible -->
    <details open>
      <summary><strong>Algorithme de Classification Amélioré</strong></summary>
      <p><strong>Luminosité :</strong>
        {% set rgb = (image[7]|replace('(', '')|replace(')', '')).split(',') %}
        {{ "%.1f"|format((rgb[0]|int * 0.299 + rgb[1]|int * 0.587 + rgb[2]|int * 0.114)) }} / 255
      </p>
      <p><strong>Contours (image) :</strong> {{ "%.4f"|format(image[9] / (image[4] * image[5])) }}</p>
      {% if image[12] and image[13] %}
      <p><strong>Contours (benne) :</strong> {{ "%.4f"|format(image[12] / image[13]) }}</p>
      {% endif %}
    </details>
  </section>
  {% endif %}

  <button id="toggleHistograms" onclick="toggleHistogramSection()">Voir plus (Histogrammes)</button>

  <div id="histogramSection" style="display: none;">
    <h3>Histogrammes</h3>
    <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
      <canvas id="colorHistogram" width="400" height="200" loading="lazy"></canvas>
      <canvas id="luminanceHistogram" width="400" height="200" loading="lazy"></canvas>
    </div>
  </div>

</main>

<script>
  // Mise à jour couleur moyenne
  (function () {
    const match = `{{ image[7] }}`.match(/\((\d+),\s*(\d+),\s*(\d+)\)/);
    if (match) {
      const [r, g, b] = match.slice(1);
      document.getElementById('avg-color-box').style.backgroundColor = `rgb(${r},${g},${b})`;
    }
  })();

  function toggleHistogramSection() {
    const section = document.getElementById('histogramSection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
    document.getElementById('toggleHistograms').textContent = section.style.display === 'none'
      ? 'Voir plus (Histogrammes)'
      : 'Voir moins';
    if (!window.chartsCreated && section.style.display === 'block') {
      createHistograms();
      window.chartsCreated = true;
    }
  }

  function createHistograms() {
    const ctxColor = document.getElementById('colorHistogram').getContext('2d');
    const ctxLuminance = document.getElementById('luminanceHistogram').getContext('2d');
    const histRGB = `{{ image[10] }}`.split(',').map(Number);
    const histLum = `{{ image[11] }}`.split(',').map(Number);
    const labels = [...Array(256).keys()];
    new Chart(ctxColor, {
      type: 'line',
      data: {
        labels: labels,
        datasets: ['Rouge', 'Vert', 'Bleu'].map((c, i) => ({
          label: c,
          data: histRGB.slice(i * 256, (i + 1) * 256),
          borderColor: ['red', 'green', 'blue'][i],
          backgroundColor: 'transparent',
          fill: false,
          tension: 0.1
        }))
      },
      options: { responsive: true }
    });

    new Chart(ctxLuminance, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Luminance',
          data: histLum,
          backgroundColor: '#888'
        }]
      },
      options: { responsive: true }
    });
  }
</script>

</body>
</html>
